<?php
    namespace DAO;

use Models\Owner;
use DAO\Connection;
use Models\Availability;
use Models\Keeper;

    class DB_OwnerDAO implements IOwnerDAO {

        private $connection;
        private $tableName = "owner";

        public function add(Owner $owner)
        {
            $sql = "INSERT INTO owner (email,userName,password,name,lastName,avatar,userRole) VALUES (:email,:userName,:password,:name,:lastName,:avatar,:userRole)";

            $parameters['email'] = $owner->getEmail();
            $parameters['userName'] = $owner->getUserName();
            $parameters['password'] = $owner->getPassword();
            $parameters['name'] = $owner->getname();
            $parameters['lastName'] = $owner->getLastName();
            $parameters['avatar'] = $owner->getAvatar();
            $parameters['userRole'] = $owner->getUserRole();


            try {
                $this->connection = Connection::GetInstance();
                return $this->connection->ExecuteNonQuery($sql,$parameters,true);
            }
            catch (\PDOException $ex) {
                throw $ex;
            }
        }

        public function getAll()
        {
            $sql = "SELECT *.owner, *.keeperInfo FROM owner LEFT JOIN keeperInfo on owner.ownerId = keeperInfo.ownerId";

            try{
                $this->connection = Connection::GetInstance();
                $result = $this->connection->Execute($sql);

            }
            catch(\PDOException $e){
                throw $e;
            }

            if(!empty($result)){
                return $this->map($result);
            }
            else{
                return false;
            }
        }

        protected function map($value)
        {
            $value = is_array($value) ? $value : [];

            $resp = array_map(function($p){
                if ($p['is_keeper']==0){
                    $owner = new Owner();
                    $owner->setId($p['ownerId']);
                    $owner->setEmail($p['email']);
                    $owner->setUserName($p['userName']);
                    $owner->setPassword($p['password']);
                    $owner->setName($p['name']);
                    $owner->setLastName($p['lastName']);
                    $owner->setAvatar($p['avatar']);
                    $owner->setUserRole($p['userRole']);
                }
                else if ($p['is_keeper']==1)
                {
                    $owner = new Keeper();
                    $owner->setId($p['ownerId']);
                    $owner->setEmail($p['email']);
                    $owner->setUserName($p['userName']);
                    $owner->setPassword($p['password']);
                    $owner->setName($p['name']);
                    $owner->setLastName($p['lastName']);
                    $owner->setAvatar($p['avatar']);
                    $owner->setUserRole($p['userRole']);

                    //keeper info
                    $owner->setPetSize($p['petSize']);
                    $owner->setPrice($p['price']);

                    $availability = new Availability();
                    $availability->setStartDate($p['startDate']);
                    $availability->setEndDate($p['endDate']);

                    // building days of week in keeper's availability:
                    $sql = "SELECT *.kixdow, dow.dayName FROM keeperInfoXdaysOfWeek kixdow join daysOfWeek dow on kixdow.dayOfWeekId = dow.dayOfWeekId where kixdow.keeperInfoId = :keeperInfoId";

                    $parameters['keeperInfoId'] = $p['keeperInfoId'];
                    try{
                        $this->connection = Connection::GetInstance();
                        $result = $this->connection->Execute($sql,$parameters);
        
                    }
                    catch(\PDOException $e){
                        throw $e;
                    }

                    $arrayOfDays = array_map(function($d){return $d['dayName'];},$result);
                    $availability->setDaysOfWeek($arrayOfDays);

                    $owner->setAvailability($availability);

                    // WIP: build date array for each keeper. need DB_DateDAO for this.
                    // set an array of all dates (using DB_DateDAO GetAll()) and filter it by keeperId.
                }
                return $owner;
            },$value)
        }

    }

?>